<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAXé€ä¿¡ç®¡ç†ç”»é¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .controls {
            margin-bottom: 30px;
            text-align: center;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .file-info {
            max-width: 200px;
            word-break: break-all;
            font-size: 12px;
        }
        .file-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .file-link:hover {
            text-decoration: underline;
            color: #0056b3;
        }
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            max-width: 200px;
            word-break: break-word;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“  FAXé€ä¿¡ç®¡ç†ç”»é¢</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-count">-</div>
                <div class="stat-label">ç·é€ä¿¡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-count">-</div>
                <div class="stat-label">å¾…æ©Ÿä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processing-count">-</div>
                <div class="stat-label">å‡¦ç†ä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-count">-</div>
                <div class="stat-label">å®Œäº†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="error-count">-</div>
                <div class="stat-label">ã‚¨ãƒ©ãƒ¼</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="refreshData()">ğŸ”„ æ›´æ–°</button>
            <button class="btn btn-success" onclick="clearCompleted()">âœ… å®Œäº†æ¸ˆã¿å‰Šé™¤</button>
            <button class="btn btn-warning" onclick="retryErrors()">ğŸ”„ ã‚¨ãƒ©ãƒ¼å†é€</button>
            <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <div id="no-data" class="no-data" style="display: none;">é€ä¿¡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <table id="fax-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ãƒ•ã‚¡ã‚¤ãƒ«</th>
                        <th>å¤‰æ›PDF</th>
                        <th>FAXç•ªå·</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>æ›´æ–°æ—¥æ™‚</th>
                        <th>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="fax-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let requests = [];
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                const response = await fetch('/requests');
                const data = await response.json();
                
                if (data.success) {
                    requests = data.requests;
                    updateStats();
                    updateTable();
                } else {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', data.error);
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 0).length;
            const processing = requests.filter(r => r.status === 2).length;
            const completed = requests.filter(r => r.status === 1).length;
            const error = requests.filter(r => r.status === -1).length;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('processing-count').textContent = processing;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('error-count').textContent = error;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        function updateTable() {
            const tbody = document.getElementById('fax-table-body');
            const loading = document.getElementById('loading');
            const noData = document.getElementById('no-data');
            const table = document.getElementById('fax-table');
            
            loading.style.display = 'none';
            
            if (requests.length === 0) {
                noData.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            
            noData.style.display = 'none';
            table.style.display = 'table';
            
            tbody.innerHTML = requests.map(request => {
                const statusClass = getStatusClass(request.status);
                const statusText = getStatusText(request.status);
                const fileInfo = getFileInfo(request.file_url, request.id);
                const convertedPdfInfo = getConvertedPdfInfo(request.converted_pdf_path, request.id);
                const createdAt = formatDateTime(request.created_at);
                const updatedAt = formatDateTime(request.updated_at);
                const errorMsg = request.error_message || '';
                
                return `
                    <tr>
                        <td>${request.id.substring(0, 8)}...</td>
                        <td class="file-info">${fileInfo}</td>
                        <td class="file-info">${convertedPdfInfo}</td>
                        <td>${request.fax_number}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td class="timestamp">${createdAt}</td>
                        <td class="timestamp">${updatedAt}</td>
                        <td class="error-message">${errorMsg}</td>
                        <td>
                            ${request.status === -1 ? `<button class="btn btn-warning" onclick="retryRequest('${request.id}')">å†é€</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getStatusClass(status) {
            switch(status) {
                case 0: return 'status-pending';
                case 1: return 'status-completed';
                case 2: return 'status-processing';
                case -1: return 'status-error';
                default: return '';
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        function getStatusText(status) {
            switch(status) {
                case 0: return 'å¾…æ©Ÿä¸­';
                case 1: return 'å®Œäº†';
                case 2: return 'å‡¦ç†ä¸­';
                case -1: return 'ã‚¨ãƒ©ãƒ¼';
                default: return 'ä¸æ˜';
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
        function getFileInfo(fileUrl, requestId) {
            if (fileUrl.startsWith('file://')) {
                const fileName = fileUrl.split('/').pop();
                return `<a href="/view_file/${requestId}" target="_blank" class="file-link" onclick="handleFileClick(event, '${requestId}')">ğŸ“ ${fileName}</a>`;
            } else {
                const url = new URL(fileUrl);
                return `<a href="${fileUrl}" target="_blank" class="file-link">ğŸŒ ${url.hostname}${url.pathname}</a>`;
            }
        }
        
        // å¤‰æ›ã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
        function getConvertedPdfInfo(convertedPdfPath, requestId) {
            if (!convertedPdfPath) {
                return '<span style="color: #999;">-</span>';
            }
            
            const fileName = convertedPdfPath.split('/').pop() || convertedPdfPath.split('\\').pop();
            return `<a href="/view_converted_pdf/${requestId}" target="_blank" class="file-link" onclick="handleConvertedPdfClick(event, '${requestId}')">ğŸ“„ ${fileName}</a>`;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function handleFileClick(event, requestId) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            fetch(`/view_file/${requestId}`)
                .then(response => {
                    if (!response.ok) {
                        event.preventDefault();
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                    }
                })
                .catch(error => {
                    event.preventDefault();
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }
        
        // å¤‰æ›ã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function handleConvertedPdfClick(event, requestId) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            fetch(`/view_converted_pdf/${requestId}`)
                .then(response => {
                    if (!response.ok) {
                        event.preventDefault();
                        alert('å¤‰æ›ã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                    }
                })
                .catch(error => {
                    event.preventDefault();
                    alert('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                });
        }
        
        // æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            loadData();
        }
        
        // å®Œäº†æ¸ˆã¿ã‚’å‰Šé™¤
        async function clearCompleted() {
            if (!confirm('å®Œäº†æ¸ˆã¿ã®é€ä¿¡å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/clear_completed', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('å®Œäº†æ¸ˆã¿ã®é€ä¿¡å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    refreshData();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼ã‚’å†é€
        async function retryErrors() {
            if (!confirm('ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®é€ä¿¡ã‚’å†é€ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const response = await fetch('/retry_errors', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®é€ä¿¡ã‚’å†é€ã—ã¾ã—ãŸ');
                    refreshData();
                } else {
                    alert('å†é€ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å…¨å‰Šé™¤
        async function clearAll() {
            if (!confirm('ã™ã¹ã¦ã®é€ä¿¡å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
            
            try {
                const response = await fetch('/clear_all', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ã™ã¹ã¦ã®é€ä¿¡å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    refreshData();
                } else {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å€‹åˆ¥å†é€
        async function retryRequest(requestId) {
            try {
                const response = await fetch(`/retry_request/${requestId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('é€ä¿¡ã‚’å†é€ã—ã¾ã—ãŸ');
                    refreshData();
                } else {
                    alert('å†é€ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // åˆæœŸèª­ã¿è¾¼ã¿
        loadData();
        
        // è‡ªå‹•æ›´æ–°ï¼ˆ30ç§’é–“éš”ï¼‰
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
