<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAX送信管理画面</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .controls {
            margin-bottom: 30px;
            text-align: center;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .file-info {
            max-width: 200px;
            word-break: break-all;
            font-size: 12px;
        }
        .file-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .file-link:hover {
            text-decoration: underline;
            color: #0056b3;
        }
        .timestamp {
            font-size: 12px;
            color: #666;
        }
        .error-message {
            color: #dc3545;
            font-size: 12px;
            max-width: 200px;
            word-break: break-word;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📠 FAX送信管理画面</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-count">-</div>
                <div class="stat-label">総送信数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-count">-</div>
                <div class="stat-label">待機中</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processing-count">-</div>
                <div class="stat-label">処理中</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completed-count">-</div>
                <div class="stat-label">完了</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="error-count">-</div>
                <div class="stat-label">エラー</div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="refreshData()">🔄 更新</button>
            <button class="btn btn-success" onclick="clearCompleted()">✅ 完了済み削除</button>
            <button class="btn btn-warning" onclick="retryErrors()">🔄 エラー再送</button>
            <button class="btn btn-danger" onclick="clearAll()">🗑️ 全削除</button>
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">データを読み込み中...</div>
            <div id="no-data" class="no-data" style="display: none;">送信履歴がありません</div>
            <table id="fax-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ファイル</th>
                        <th>変換PDF</th>
                        <th>FAX番号</th>
                        <th>ステータス</th>
                        <th>作成日時</th>
                        <th>更新日時</th>
                        <th>エラーメッセージ</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="fax-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let requests = [];
        
        // データを読み込み
        async function loadData() {
            try {
                const response = await fetch('/requests');
                const data = await response.json();
                
                if (data.success) {
                    requests = data.requests;
                    updateStats();
                    updateTable();
                } else {
                    console.error('データの読み込みに失敗:', data.error);
                }
            } catch (error) {
                console.error('エラー:', error);
            }
        }
        
        // 統計情報を更新
        function updateStats() {
            const total = requests.length;
            const pending = requests.filter(r => r.status === 0).length;
            const processing = requests.filter(r => r.status === 2).length;
            const completed = requests.filter(r => r.status === 1).length;
            const error = requests.filter(r => r.status === -1).length;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('processing-count').textContent = processing;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('error-count').textContent = error;
        }
        
        // テーブルを更新
        function updateTable() {
            const tbody = document.getElementById('fax-table-body');
            const loading = document.getElementById('loading');
            const noData = document.getElementById('no-data');
            const table = document.getElementById('fax-table');
            
            loading.style.display = 'none';
            
            if (requests.length === 0) {
                noData.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            
            noData.style.display = 'none';
            table.style.display = 'table';
            
            tbody.innerHTML = requests.map(request => {
                const statusClass = getStatusClass(request.status);
                const statusText = getStatusText(request.status);
                const fileInfo = getFileInfo(request.file_url, request.id);
                const convertedPdfInfo = getConvertedPdfInfo(request.converted_pdf_path, request.id);
                const createdAt = formatDateTime(request.created_at);
                const updatedAt = formatDateTime(request.updated_at);
                const errorMsg = request.error_message || '';
                
                return `
                    <tr>
                        <td>${request.id.substring(0, 8)}...</td>
                        <td class="file-info">${fileInfo}</td>
                        <td class="file-info">${convertedPdfInfo}</td>
                        <td>${request.fax_number}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td class="timestamp">${createdAt}</td>
                        <td class="timestamp">${updatedAt}</td>
                        <td class="error-message">${errorMsg}</td>
                        <td>
                            ${request.status === -1 ? `<button class="btn btn-warning" onclick="retryRequest('${request.id}')">再送</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // ステータスクラスを取得
        function getStatusClass(status) {
            switch(status) {
                case 0: return 'status-pending';
                case 1: return 'status-completed';
                case 2: return 'status-processing';
                case -1: return 'status-error';
                default: return '';
            }
        }
        
        // ステータステキストを取得
        function getStatusText(status) {
            switch(status) {
                case 0: return '待機中';
                case 1: return '完了';
                case 2: return '処理中';
                case -1: return 'エラー';
                default: return '不明';
            }
        }
        
        // ファイル情報を取得
        function getFileInfo(fileUrl, requestId) {
            if (fileUrl.startsWith('file://')) {
                const fileName = fileUrl.split('/').pop();
                return `<a href="/view_file/${requestId}" target="_blank" class="file-link" onclick="handleFileClick(event, '${requestId}')">📁 ${fileName}</a>`;
            } else {
                const url = new URL(fileUrl);
                return `<a href="${fileUrl}" target="_blank" class="file-link">🌐 ${url.hostname}${url.pathname}</a>`;
            }
        }
        
        // 変換されたPDFファイル情報を取得
        function getConvertedPdfInfo(convertedPdfPath, requestId) {
            if (!convertedPdfPath) {
                return '<span style="color: #999;">-</span>';
            }
            
            const fileName = convertedPdfPath.split('/').pop() || convertedPdfPath.split('\\').pop();
            return `<a href="/view_converted_pdf/${requestId}" target="_blank" class="file-link" onclick="handleConvertedPdfClick(event, '${requestId}')">📄 ${fileName}</a>`;
        }
        
        // ファイルクリック時のエラーハンドリング
        function handleFileClick(event, requestId) {
            // ファイルが存在しない場合のエラーハンドリング
            fetch(`/view_file/${requestId}`)
                .then(response => {
                    if (!response.ok) {
                        event.preventDefault();
                        alert('ファイルが見つかりません。ファイルが削除されている可能性があります。');
                    }
                })
                .catch(error => {
                    event.preventDefault();
                    alert('ファイルの読み込み中にエラーが発生しました。');
                });
        }
        
        // 変換されたPDFファイルクリック時のエラーハンドリング
        function handleConvertedPdfClick(event, requestId) {
            // ファイルが存在しない場合のエラーハンドリング
            fetch(`/view_converted_pdf/${requestId}`)
                .then(response => {
                    if (!response.ok) {
                        event.preventDefault();
                        alert('変換されたPDFファイルが見つかりません。ファイルが削除されている可能性があります。');
                    }
                })
                .catch(error => {
                    event.preventDefault();
                    alert('PDFファイルの読み込み中にエラーが発生しました。');
                });
        }
        
        // 日時をフォーマット
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP');
        }
        
        // データを更新
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            loadData();
        }
        
        // 完了済みを削除
        async function clearCompleted() {
            if (!confirm('完了済みの送信履歴を削除しますか？')) return;
            
            try {
                const response = await fetch('/clear_completed', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('完了済みの送信履歴を削除しました');
                    refreshData();
                } else {
                    alert('削除に失敗しました: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        // エラーを再送
        async function retryErrors() {
            if (!confirm('エラー状態の送信を再送しますか？')) return;
            
            try {
                const response = await fetch('/retry_errors', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('エラー状態の送信を再送しました');
                    refreshData();
                } else {
                    alert('再送に失敗しました: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        // 全削除
        async function clearAll() {
            if (!confirm('すべての送信履歴を削除しますか？この操作は取り消せません。')) return;
            
            try {
                const response = await fetch('/clear_all', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('すべての送信履歴を削除しました');
                    refreshData();
                } else {
                    alert('削除に失敗しました: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        // 個別再送
        async function retryRequest(requestId) {
            try {
                const response = await fetch(`/retry_request/${requestId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('送信を再送しました');
                    refreshData();
                } else {
                    alert('再送に失敗しました: ' + data.error);
                }
            } catch (error) {
                alert('エラーが発生しました: ' + error.message);
            }
        }
        
        // 初期読み込み
        loadData();
        
        // 自動更新（30秒間隔）
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
